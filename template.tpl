___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Blind Creator Tag",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING"
  ],  
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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0ZzFVCJwYHOCWicIOPitGCAjxvJEl4BkIU41KBRzQIBnOBFxRWjE6NJlDkwGOo5u+Q5MiNf8JmV8RojZm+fWNmu7YLf6ILrAwBogEFsWCGKzEAyweUQCIqUpboew4Gf1gm6WhBgyhBUQIS90HQiEu/EhUAmAXISM8zAQjGaPkAmAjmicYgc0kzLQC0aHtFNPetF5n3WVGIxOT6tBB5kdDSKCA5ELYyLzPVBDYMJzJmfkDKfWB43J8vXgE6lCgF45koZwQjRQxYJDA0AsLV10kQYYBEdER4AIWjJH3ACxDsy6OKiYIMRgKEZ4YzA2RwfZApof4AjQoF873JcviVFGKBoNYMjxFwliDljonbXeATqpERiTTFXCAQEtgQnImAeCOyCXFqhnBmkZDWu6giY52DB0kGHhLDOSbnwCEpE4F0kYcYBEdP8AX1Fqi1RaotUWqLVFqi1RaotUWqLVFqi1RaotUWqLVFqi1RaotUWqLVFqi1RaotUWqLVFqi1RaotUWqLVFqi1Rap9f//aAAwDAQACAAMAAAAQ888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888895+80+w842w739888888aNNNNMFdxRxx93888888f+p+Msxqceuu1V8888888++/8+1908827X8888888r2Mv+9Svct/y888888888tYzoFue46ue888888888888888888888888888dSF6he37159s/9w88888kBcfUX2HkaX+NW388888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888/8QAIREBAQEAAgEEAwEAAAAAAAAAAQARMWEhECBBUTBAYIH/2gAIAQMBAT8Q/p1Cx92Pu7Luuy7ruu67ruu67IR49/w/UEPMMREd26rquqIBkc3RY+rH1Y+p/CZavLQ75Pb2TPn1wYc+mAfgM5IsbibX1c7ArhOdhx0gOZbiXebV1+I+chxdMjmLjcxMRhYzz+6PPN5DIzq/Ehkg5MNYFl4J4Nh8CSs8yQegBw9zBMhGJH/SLBW6QTynXc5g8Ezi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"
  },
  "description": "Blind Creator Tag API tag for Google Tag Manager Server Container",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "Section 1 - Blind Creator Tag Settings",
    "displayName": "Blind Creator Tag Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "bc_tag_event_name",
        "displayName": "Event name",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "page_visit",
            "displayValue": "Page Visit"
          },
          {
            "value": "add_to_cart",
            "displayValue": "Add to cart"
          },
          {
            "value": "conversion",
            "displayValue": "Conversion"
          }
        ],
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require("logToConsole");
const Object = require("Object");
const JSON = require("JSON");
const decode = require('decodeUriComponent');
const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');
const localStorage = require('localStorage');
const sendPixel = require('sendPixel');
const encodeUriComponent = require('encodeUriComponent');
const getTimestamp = require('getTimestamp');

// default values
const apiUrl = 'https://02ca2gksv2.execute-api.us-east-1.amazonaws.com/default/new-event';
const localStorageVariable = 'bc_tracker_utm';

function saveQueryParametersAsCookie() { 
  var referralHost = getReferrerUrl("hostname");
  var hostname = getUrl("hostname");
  var queryString = getUrl("query"); 
  if (queryString.indexOf(localStorageVariable) !== -1) {            
    queryString += "&created_at=" + getTimestamp();
    queryString += "&hostname=" + encodeUriComponent(hostname);           
    queryString += "&referral_hostname=" + encodeUriComponent(referralHost);       
    localStorage.setItem(localStorageVariable, "?"+queryString);
  }  
}
  
function sendEventToBCAPI(eventName) {
  var localStorageValue = localStorage.getItem(localStorageVariable);  
  sendPixel(apiUrl+encodeUriComponent(localStorageValue)+"&bc_tag_event_name="+eventName);
}

const validate = (data) => {
  const errors = [];
  const warnings = [];
  // errors
  if (data.bc_tag_event_name !== "page_visit" && data.bc_tag_event_name !== "add_to_cart" && data.bc_tag_event_name !== "conversion") {
    errors.push("data.bc_tag_event_name not found");
  }  
  // warnings
  if (data.email) {

  }
  for (const msg of warnings) {
    log("[WARN] " + msg);
  }
  for (const msg of errors) {
    log("[ERROR] " + msg);
  }
  return errors;
};

const start = (data) => {
  
  const errors = validate(data);
  if (errors.length > 0) {
    log("errors:", errors);
    data.gtmOnFailure();
    return;
  }

  saveQueryParametersAsCookie();
  
  if(data.bc_tag_event_name==="page_visit"){
    sendEventToBCAPI("page_visit");
  } else if(data.bc_tag_event_name==="add_to_cart"){
    sendEventToBCAPI("add_to_cart");
  } else if(data.bc_tag_event_name==="conversion"){
    sendEventToBCAPI("conversion");
  }
  
  data.gtmOnSuccess();
};

start(data);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "bc_tracker_utm"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Basic
  code: |-
    const mockData = {
      event: 'ViewContent',
      bc_tag_event_name: "page_visit",
    };
    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
setup: ''


___NOTES___

Created on 10/27/2023, 7:53:04 AM


